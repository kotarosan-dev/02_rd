# 書影検索 - 候補絞り込みロジック

## 基本方針

候補は**3-5件に絞り込んで提示**する。多すぎると判断が困難になり、少なすぎると見落としのリスクがある。

## 絞り込み優先順位

### 優先度1: 出版社・レーベル（最重要）

#### 判定基準
- 背表紙の色の記憶
- 出版社ロゴの記憶
- レーベルの特徴（ハヤカワSFの青背など）

#### 絞り込み方法
1. 背表紙の色から出版社を推定
   - 青系 → ハヤカワ文庫SF
   - 緑系 → ハヤカワ文庫JA、角川文庫
   - ピンク系 → 創元SF文庫
   - 白/ベージュ → ちくま文庫など

2. 該当出版社の作品リストから候補を抽出
3. 表紙画像を確認して絞り込み

#### 効果
- 検索範囲を大幅に縮小できる
- 最も効率的な絞り込み方法

### 優先度2: 刊行時期

#### 判定基準
- 見た時期（2010年前後）
- 出版時期の推定（90年代など）

#### 絞り込み方法
1. 見た時期から出版時期を推定
   - 2010年見た → 2000年代後半〜2010年頃の出版
   - ただし、古本の可能性も考慮

2. 該当時期の出版リストから候補を抽出
3. 表紙デザインのトレンドを考慮

#### 効果
- 時代的な表紙デザインの特徴で絞り込み可能

### 優先度3: 表紙デザイナー・イラストレーター

#### 判定基準
- 参照表紙の装画情報
- 表紙スタイルの類似性

#### 絞り込み方法
1. 参照表紙（「タウ・ゼロ」など）の装画情報を確認
   - 「タウ・ゼロ」: Dave Archer/Edgerly Associates

2. 同じ装画スタジオ・デザイナーの作品を検索
3. 類似スタイルの表紙を持つ作品を抽出

#### 効果
- 視覚的な類似性が高い候補を特定できる

### 優先度4: タイトルキーワード

#### 判定基準
- 覚えているキーワード（「永遠」「時間」「旅」など）
- タイトルの雰囲気

#### 絞り込み方法
1. キーワードで検索
2. タイトルの雰囲気が近い作品を抽出
3. 表紙画像を確認

#### 効果
- タイトルから直接候補を特定できる場合がある

## 候補評価スコアリング

### 評価項目と重み

各候補を以下の項目で評価し、総合スコアで順位付けする。

#### 1. 視覚的特徴の一致度（重み: 40%）

**人物の特徴**（10点満点）
- シルエット/実写: 2点
- ポーズ: 3点
- 性別: 2点
- サイズ・配置: 3点

**背景の特徴**（10点満点）
- 色: 3点
- 惑星の配置: 3点
- 光線の有無: 2点
- スタイル: 2点

**レイアウト**（10点満点）
- 人物と背景の配置関係: 5点
- 全体のバランス: 5点

**スタイル**（10点満点）
- 写実的/抽象的: 5点
- アート的/商業的: 5点

#### 2. 書籍情報の一致度（重み: 30%）

**出版社・レーベル**（10点満点）
- 確定している場合: 10点
- 可能性がある場合: 5点
- 違う場合: 0点

**刊行時期**（10点満点）
- 完全一致: 10点
- 近い時期: 7点
- やや離れている: 3点
- 大きく違う: 0点

**判型**（10点満点）
- 一致: 10点
- 可能性あり: 5点
- 違う: 0点

#### 3. タイトルの一致度（重み: 20%）

**キーワードの一致**（10点満点）
- 複数のキーワードが一致: 10点
- 1つのキーワードが一致: 5点
- 一致なし: 0点

**タイトル形式**（10点満点）
- 漢字ひらがなのみ: 10点
- カタカナ含む: 0点

#### 4. 参照表紙との類似度（重み: 10%）

**「永遠の終り」との類似度**（5点満点）
- 非常に近い: 5点
- 近い: 3点
- やや近い: 1点
- 違う: 0点

**「タウ・ゼロ」との類似度**（5点満点）
- 非常に近い: 5点
- 近い: 3点
- やや近い: 1点
- 違う: 0点

### 総合スコアの計算

```
総合スコア = 
  視覚的特徴の一致度 × 0.4 +
  書籍情報の一致度 × 0.3 +
  タイトル一致度 × 0.2 +
  参照表紙類似度 × 0.1
```

### スコアリング例

#### 候補A: 「天の光はすべて星」（フレドリック・ブラウン、ハヤカワ文庫SF）
- 視覚的特徴: 70点（人物は座っている、ポーズが違う）
- 書籍情報: 50点（ハヤカワは対象外だが、時期は近い）
- タイトル: 100点（漢字ひらがな、キーワード一致）
- 参照表紙類似度: 60点
- **総合スコア: 68点**

#### 候補B: 「虚空の眼」（フィリップ・K・ディック、サンリオSF文庫）
- 視覚的特徴: 80点（ポーズは一致、色が違う）
- 書籍情報: 70点（時期は近い、出版社は違う）
- タイトル: 100点（漢字ひらがな）
- 参照表紙類似度: 50点
- **総合スコア: 78点**

## 候補提示フォーマット

### 各候補の提示内容

1. **書籍情報**
   - タイトル（原題）
   - 著者名
   - 出版社・レーベル
   - 刊行年
   - ISBN（可能であれば）

2. **表紙画像**
   - 表紙画像へのリンクまたは画像
   - 複数の版がある場合は主要な版を提示

3. **一致点・相違点**
   - **一致している点**（3-5点）
   - **違う点**（2-3点）
   - **近さの度合い**（10段階評価）

4. **追加情報**
   - 装画・デザイナー情報
   - 内容の簡単な紹介
   - 入手可能性

### 提示例

```
【候補1】「虚空の眼」（フィリップ・K・ディック）
出版社: サンリオSF文庫（1986年）
表紙画像: [画像リンク]

一致している点:
✓ 人物シルエットが両腕を広げている
✓ 宇宙的な背景
✓ タイトルが漢字ひらがなのみ
✓ 2010年以前の刊行

違う点:
✗ 人物シルエットが白ではなくブロンズ色
✗ 出版社がサンリオ（ハヤカワ・創元以外だが）

近さの度合い: 7/10

装画: [デザイナー情報]
内容: [簡単な紹介]
```

## フィードバック後の再評価

### フィードバックの反映

1. **「近い」と評価された候補**
   - どの要素が近いかを記録
   - その要素を重視して他の候補を再評価
   - 類似する候補を追加検索

2. **「違う」と評価された候補**
   - なぜ違うかを記録
   - その要素を除外条件に追加
   - 類似候補を除外

3. **新しい情報の追加**
   - 新情報を評価項目に反映
   - スコアを再計算
   - 候補リストを更新

### 再絞り込み

フィードバック後、以下の方法で再絞り込み：

1. **除外条件の明確化**
   - 「違う」と評価された候補の特徴を除外条件に追加
   - 類似する候補を除外

2. **重点項目の変更**
   - 「近い」と評価された要素の重みを上げる
   - スコアを再計算

3. **新規候補の追加**
   - 「近い」候補と類似する作品を検索
   - 評価スコアリングに追加
