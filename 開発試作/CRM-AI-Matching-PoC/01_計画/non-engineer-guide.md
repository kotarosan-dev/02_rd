# CRM-AI マッチングシステム：非エンジニア向け解説ガイド

> このドキュメントは、今回のPoCで使われた技術を、非エンジニアの方にも理解できるように解説したものです。

---

## 目次

1. [全体像：何を作ったのか](#1-全体像何を作ったのか)
2. [登場人物（コンポーネント）の役割](#2-登場人物コンポーネントの役割)
3. [CORSとは何か](#3-corsとは何か)
4. [外部連携（CRM Connection）の仕組み](#4-外部連携crm-connectionの仕組み)
5. [I/O（Input/Output）とは](#5-ioinputoutputとは)
6. [AIはどこで使われているか](#6-aiはどこで使われているか)
7. [全体のデータの流れ](#7-全体のデータの流れ)
8. [よくある質問](#8-よくある質問)

---

## 1. 全体像：何を作ったのか

### 一言で言うと

**「求職者の情報を入れると、AIが自動で合いそうな求人を見つけてくれるシステム」**

### たとえ話

```
従来のやり方（手動）：
  人事担当者が求職者の情報を見る
    → 求人票を1つずつ確認
    → 「この人にはこの求人が合いそう」と判断
    → 時間がかかる、見落としもある

今回のシステム（AI）：
  求職者の情報を入力
    → AIが全求人の中から「意味的に近い」ものを瞬時に発見
    → 上位3件を自動表示
    → 速い、網羅的
```

---

## 2. 登場人物（コンポーネント）の役割

### メインキャスト3名

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  【1. CRMウィジェット】                                              │
│     役割：受付係・表示係                                             │
│     場所：Zoho CRMの画面の中                                         │
│     やること：                                                       │
│       - ユーザーの操作を受け付ける（「マッチング検索」ボタン）        │
│       - 結果を画面に表示する                                         │
│     たとえ：レストランのウェイター                                   │
│                                                                     │
│  【2. Catalyst関数】                                                 │
│     役割：中継係・橋渡し役                                           │
│     場所：Zohoのクラウド上                                           │
│     やること：                                                       │
│       - ウィジェットからのリクエストを受け取る                       │
│       - Pineconeに問い合わせる                                       │
│       - 結果をウィジェットに返す                                     │
│     たとえ：厨房への注文を伝えるキッチンスタッフ                     │
│                                                                     │
│  【3. Pinecone】                                                     │
│     役割：AI検索エンジン                                             │
│     場所：Pinecone社のクラウド上                                     │
│     やること：                                                       │
│       - 求人データを保管                                             │
│       - 「意味的に似ている」求人を検索                               │
│     たとえ：超優秀な図書館司書（内容を理解して本を探せる）           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 図解

```
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│              │      │              │      │              │
│  CRM         │ ──→ │  Catalyst    │ ──→ │  Pinecone    │
│  ウィジェット  │      │  関数        │      │  (AI検索)    │
│              │ ←── │              │ ←── │              │
│  [受付・表示] │      │  [中継]      │      │  [検索]      │
│              │      │              │      │              │
└──────────────┘      └──────────────┘      └──────────────┘
   ウェイター            キッチンスタッフ        シェフ
```

---

## 3. CORSとは何か

### 問題：なぜ直接通信できなかったのか

最初、CRMウィジェットから直接Pineconeに接続しようとしましたが、エラーになりました。
これは「CORS（コルス）」というセキュリティの仕組みが原因です。

### たとえ話：マンションのセキュリティ

```
【CORSのたとえ：マンションの訪問ルール】

あなた = CRMウィジェット
友人の家 = Pinecone

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【普通のマンション（CORSなし）】

  あなた「友人の家に行きたい」
    → そのまま入れる
    → 問題なし

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【セキュリティ付きマンション（CORSあり）】

  あなた「友人の家に行きたい」
    ↓
  警備員「どちらからいらっしゃいましたか？」
    ↓
  あなた「○○マンションから来ました」
    ↓
  警備員「（許可リストを確認）...○○マンションは許可されていません」
    ↓
  あなた「入れない...」😢

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【問題】
  CRMウィジェットの住所（ドメイン）は毎回変わる
  → Pinecone側で事前に許可リストに登録できない
  → 永遠に「許可されていません」と言われる

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【解決策】
  信頼できる仲介者（Catalyst）を経由する

  あなた → 仲介者 → 友人の家
  
  仲介者は「Zohoからの正規の依頼」として訪問
  → Pinecone側は「Zoho（Catalyst）は許可済み」
  → 無事に入れる ✅
```

### なぜCORSが存在するのか

CORSは「悪意のあるサイトが勝手にデータを盗むのを防ぐ」ためのセキュリティ機能です。

```
【CORSがなかったら...】

悪意のあるサイト「銀行のサイトに接続して残高を盗もう」
  → 簡単にできてしまう 😱

【CORSがあると】

悪意のあるサイト「銀行のサイトに接続して...」
銀行「あなたは許可リストにいません。アクセス拒否。」
  → 守られる 🛡️
```

---

## 4. 外部連携（CRM Connection）の仕組み

### 「外部連携」とは

Zoho CRMから外部のサービス（Pinecone、Catalyst等）と通信するための仕組みです。

### 2種類の外部連携

今回、2種類の外部連携を試しました。

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  【タイプ1：Zoho Catalyst 接続】                                     │
│                                                                     │
│    イメージ：社内専用エレベーター                                    │
│                                                                     │
│    ・Zoho社内のサービス（Catalyst）専用の接続方法                    │
│    ・Catalystの「倉庫機能」（Data Store）などに接続するためのもの    │
│    ・今回のような「自作の関数」には使えなかった ❌                    │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【タイプ2：カスタムサービス 接続】                                   │
│                                                                     │
│    イメージ：外部業者も使える共用エレベーター                        │
│                                                                     │
│    ・どんな外部サービスにも接続できる汎用的な方法                    │
│    ・「このURLに行ってください」と指示するだけ                       │
│    ・今回はこちらを使用 ✅                                           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### たとえ話：オフィスビルの入館方法

```
【Zoho Catalyst 接続 = 社員証タッチ】

  あなた「Zohoビル3階のData Store倉庫に行きたい」
    → 社員証をピッ
    → 自動で3階に案内される
    
  ただし...
  あなた「Zohoビル5階の自作オフィスに行きたい」
    → 社員証では5階に行けない
    → 「その階は対応していません」


【カスタムサービス接続 = 受付で行き先を伝える】

  あなた「5階の○○オフィスに行きたい」
    → 受付「承知しました。ご案内します」
    → どこにでも行ける
    
  今回の設定：
    - 行き先（URL）：Catalyst関数のアドレス
    - 認証：不要（ダミーで可）
      → なぜダミーで良いか：Catalyst側で別途認証しているから
```

### なぜダミーのAPIキーで動いたのか

```
【カスタムサービス接続の設定画面】

  接続名：catalyst_custom_io
  URL：https://ai-matching-xxxxx.catalyst.zoho.com/server/...
  APIキー：dummy（適当な文字列）  ← なぜこれでOK？


【理由】

  1. カスタムサービス接続は「代理で通信する」だけ
     → 「この住所に届けてください」と郵便局に頼むようなもの
     → 郵便局自体は中身を確認しない

  2. 認証はCatalyst側で行っている
     → Catalyst関数の中でPineconeのAPIキーを使用
     → CRM側で認証する必要がない

  3. Zohoの仕様上、APIキー欄は空にできない
     → 何か入れる必要がある
     → 使わないけど「dummy」と入力
     → システム的には問題なし
```

---

## 5. I/O（Input/Output）とは

### I/O = 入力と出力

```
Input（入力）  →  処理  →  Output（出力）
   I                          O

例：
  「カレーください」（入力）
    → 調理（処理）
    → カレーが出てくる（出力）
```

### Basic I/O と Advanced I/O

Catalyst関数には2種類あります。

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  【Basic I/O = 屋台】                                                │
│                                                                     │
│    特徴：                                                           │
│      - 1種類の料理だけ提供（たこ焼き専門）                          │
│      - 設備シンプル、すぐ始められる                                 │
│      - 維持費が安い                                                 │
│                                                                     │
│    向いている場面：                                                  │
│      - 「メール送信だけ」「データ変換だけ」など単純な処理            │
│      - サッと作りたいとき                                           │
│      - プログラミング初心者                                         │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【Advanced I/O = レストラン】                                       │
│                                                                     │
│    特徴：                                                           │
│      - メニュー豊富（カレーもラーメンも寿司も）                      │
│      - 設備が必要、準備に時間がかかる                               │
│      - 維持費が高い                                                 │
│                                                                     │
│    向いている場面：                                                  │
│      - 複数の機能が必要なとき                                       │
│      - 本格的なシステム                                             │
│      - 将来拡張する予定があるとき                                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 今回の選択

```
今回のマッチングシステムで必要だった機能：

  1. /search  → マッチング検索
  2. /upsert  → 求人データの登録
  3. /health  → 動作確認

→ 3種類の「メニュー」が必要
→ Basic I/O だと3つ別々の関数を作る必要がある
→ Advanced I/O なら1つの関数で全部できる
→ 管理が楽なので Advanced I/O を選択 ✅
```

### 比較表

| 観点 | Basic I/O（屋台） | Advanced I/O（レストラン） |
|------|-------------------|---------------------------|
| **シンプルさ** | ✅ とても簡単 | ❌ やや複雑 |
| **学習コスト** | ✅ 低い | ❌ 高い |
| **起動速度** | ✅ 速い | ❌ やや遅い |
| **柔軟性** | ❌ 1つの処理のみ | ✅ 複数の処理が可能 |
| **拡張性** | ❌ 低い | ✅ 高い |

---

## 6. AIはどこで使われているか

### 最初の想定 vs 実際

```
【最初の想定】

  OpenAI（ChatGPT）のAPIを使う
    → テキストを「ベクトル」に変換
    → そのベクトルでPineconeを検索


【実際】

  Pinecone だけで完結
    → Pinecone自体にAI機能（Integrated Inference）が内蔵されていた
    → OpenAIは不要になった
```

### AIの役割

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  【Pinecone = 超優秀な図書館司書】                                   │
│                                                                     │
│  普通の検索（キーワード検索）：                                       │
│    「Python」で検索 → "Python"という文字が含まれる本だけ見つかる     │
│                                                                     │
│  AIによる検索（セマンティック検索）：                                 │
│    「Python」で検索 → "Python"が含まれる本                          │
│                      + "プログラミング"の本                         │
│                      + "データ分析"の本                             │
│                      + "機械学習"の本                               │
│    → 意味的に関連するものも見つかる                                 │
│                                                                     │
│  これを可能にするのが「ベクトル化」という技術                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### ベクトル化とは

```
【たとえ話：本の「雰囲気」を数値化】

普通の分類：
  「プログラミングの本」→ 棚番号5
  「料理の本」→ 棚番号12
  → カテゴリが違うと関連が見えない

ベクトル化：
  「Pythonプログラミング入門」→ [0.8, 0.2, 0.1, 0.9, ...]
  「機械学習の基礎」→ [0.7, 0.3, 0.2, 0.85, ...]
  「フランス料理のレシピ」→ [0.1, 0.9, 0.8, 0.1, ...]

  → 数値が近い = 内容が似ている
  → PythonとMLは数値が近い → 関連書籍として見つかる
```

### 今回のシステムでのAI活用

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  【データ登録時】                                                    │
│                                                                     │
│  求人情報「Python経験者募集、年収600万、東京勤務」                   │
│    ↓                                                                │
│  Pineconeが自動でベクトル化                                         │
│    ↓                                                                │
│  [0.82, 0.15, 0.33, ...] として保存                                 │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【検索時】                                                          │
│                                                                     │
│  求職者「プログラミングできます、東京希望、年収500万以上」           │
│    ↓                                                                │
│  Pineconeが自動でベクトル化                                         │
│    ↓                                                                │
│  [0.80, 0.18, 0.30, ...] ← さっきの求人と数値が近い！               │
│    ↓                                                                │
│  「この求人がマッチします」と返答                                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Catalystの役割（補足）

```
【よくある誤解】
  「CatalystのAIを使ったんですか？」

【回答】
  いいえ。CatalystにもAI機能（Zia Services）はありますが、
  今回は使っていません。

  Catalystの役割は「橋渡し」だけ：
    CRMウィジェット ←→ Catalyst ←→ Pinecone
                        ↑
                   ここは単なる中継
                   AI処理はしていない

  AI処理はすべてPinecone側で実行しています。
```

---

## 7. 全体のデータの流れ

### マッチング検索の流れ

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  ① ユーザーがCRMで「マッチング検索」ボタンをクリック                 │
│     ↓                                                               │
│  ② CRMウィジェットが求職者の情報を取得                              │
│     （スキル：Python、希望年収：500万、希望勤務地：東京）            │
│     ↓                                                               │
│  ③ ウィジェットが「外部連携」を通じてCatalystに送信                 │
│     ↓                                                               │
│  ④ Catalystが受け取った情報をPineconeに転送                         │
│     ↓                                                               │
│  ⑤ PineconeがAIで「意味的に近い」求人を検索                         │
│     ↓                                                               │
│  ⑥ Pineconeが上位3件の求人を返答                                    │
│     ↓                                                               │
│  ⑦ Catalystが結果をウィジェットに返送                               │
│     ↓                                                               │
│  ⑧ ウィジェットが画面に結果を表示                                   │
│     「この3件の求人がマッチしました！」                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 図解

```
[CRM画面]                [Zohoクラウド]              [外部クラウド]
                         
┌─────────┐    ③④    ┌─────────┐    ⑤⑥    ┌─────────┐
│         │ ───────→ │         │ ───────→ │         │
│ ウィ    │          │ Catalyst │          │ Pinecone│
│ ジェット │ ←─────── │ 関数     │ ←─────── │ (AI)    │
│         │    ⑦⑧    │         │          │         │
└─────────┘          └─────────┘          └─────────┘
    ↑
  ①②
  ユーザー操作
```

---

## 8. よくある質問

### Q1: なぜCRMから直接Pineconeに接続しなかったの？

**A:** CORSというセキュリティ機能が原因です。ブラウザ上で動くCRMウィジェットから、別のサービス（Pinecone）に直接アクセスすることは、セキュリティ上ブロックされます。そのため、Catalyst（Zohoのサーバー）を経由する必要がありました。

### Q2: Catalystって必要なの？Pineconeだけでできない？

**A:** 技術的にはPineconeだけでもAI検索はできます。しかし、CRMウィジェットからPineconeに直接アクセスするとCORSエラーになります。Catalystは「CRMとPineconeの間を安全に橋渡しする」ために必要です。

### Q3: OpenAIは結局使わなかったの？

**A:** 使いませんでした。当初はOpenAIでテキストをベクトル化する予定でしたが、PineconeのIntegrated Inference機能（ベクトル化が内蔵されている機能）を使うことで、OpenAIなしで実現できました。

### Q4: Basic I/OとAdvanced I/O、どっちを使えばいい？

**A:** 
- 1つの処理だけなら → Basic I/O（シンプルで簡単）
- 複数の処理が必要なら → Advanced I/O（今回のケース）

### Q5: 「外部連携」のAPIキーがダミーでいいのはなぜ？

**A:** 「外部連携」の設定画面にあるAPIキー欄は、接続先（今回はCatalyst）の認証に使われます。しかし、Catalyst関数自体はZoho内のサービスなので、CRMからのアクセスは信頼されています。実際のPineconeへの認証は、Catalyst関数の中で別途行っているため、外部連携のAPIキー欄は使用されません。システム上空欄にできないため、ダミーの値を入れています。

### Q6: セキュリティは大丈夫？

**A:** 以下の対策を行っています：
- PineconeのAPIキーはCatalystの環境変数に保存（コードには書かない）
- CORSにより、許可されていないサイトからのアクセスはブロック
- 通信はすべてHTTPS（暗号化）

---

## まとめ

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  【今回作ったシステム】                                              │
│                                                                     │
│    求職者の情報 → AIが自動マッチング → 合う求人を表示                │
│                                                                     │
│  【使った技術と役割】                                                │
│                                                                     │
│    ・CRMウィジェット：画面表示（ウェイター）                         │
│    ・Catalyst関数：橋渡し（キッチンスタッフ）                        │
│    ・Pinecone：AI検索（シェフ）                                      │
│    ・外部連携：安全な通信経路（セキュリティゲート）                  │
│                                                                     │
│  【ポイント】                                                        │
│                                                                     │
│    ・CORS対策のためCatalystを経由                                    │
│    ・AI処理はPineconeのみ（OpenAI不要）                              │
│    ・Advanced I/Oで複数機能を1つの関数に集約                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

*このドキュメントは2026年2月1日に作成されました。*
*CRM-AI Matching PoC プロジェクトの一部として管理されています。*
