# 既存実装の確認（ai_matching）

**確認日**: 2026-02-09  
**目的**: Catalyst コンソールにデプロイされている「ai_matching」とリポジトリ内実装の対応を明確にする。

---

## 1. コンソール上の既存デプロイ

| 項目 | 内容 |
|------|------|
| **関数名** | ai_matching |
| **スタック** | **Node.js**（index.js, package.json, node_modules が存在） |
| **構成** | catalyst-config.json / index.js / node_modules（package.json, package-lock.json） |

→ **Python の ZIP をこの関数にアップロードすると「Stack for the function type」でエラーになる。既存は Node なので、**Node 用の ZIP で更新する必要がある。**

---

## 2. リポジトリ内の実装と対応関係

| フォルダ | 言語 | stack | コンソールとの一致 | 備考 |
|----------|------|-------|--------------------|------|
| **02_テスト/catalyst-bundle-nodejs/ai_matching** | Node.js | node18 | ◎ 同じ Node | **デプロイはここだけ使用。** Express + @pinecone-database/pinecone。マッチング理由生成あり。 |
| **02_テスト/archive/catalyst-upload-node** | Node.js | node20 | （退避） | 別実装。参照用。 |
| **02_テスト/archive/catalyst-function-python** | Python | python39 | （退避） | 未使用。参照用。 |
| **02_テスト/archive/catalyst-bundle-python** | Python | python39 | （退避） | 未使用。参照用。 |

---

## 3. catalyst-config.json（既存・Node 用）

コンソールの ai_matching が **Node.js** の場合、ZIP 内の config は **Node 用** である必要がある。

**catalyst-bundle-nodejs/ai_matching の config（node18）:**
```json
{"deployment":{"name":"ai_matching","stack":"node18","type":"advancedio"},"execution":{"main_function":"index.handler"}}
```

- **type** は必ず **`advancedio`**（すべて小文字）。
- **stack** はコンソールで作成した関数のスタック（node18 / node20 等）に**完全に一致**させる。
- **config の形式**はコンソール側の仕様に合わせる。Invalid が出る場合は、**コンソールで表示されている既存の catalyst-config.json をそのまま貼り付け**て上書きする。

---

## 4. デプロイで使う ZIP の中身

- **既存の ai_matching（Node）を更新する場合**  
  - **catalyst-bundle-nodejs/ai_matching** の中身（catalyst-config.json, index.js, package.json, package-lock.json, node_modules）を **フォルダの中に入ったファイルだけ** で ZIP にまとめる（ZIP のルートに catalyst-config.json があること）。
- **Python 版（マッチング理由つき）を新規で使う場合**  
  - Catalyst で **新規に Python 関数** を 1 つ作成し、**catalyst-function** の main.py + requirements.txt + catalyst-config.json を ZIP でアップロードする。

---

## 5. マッチング理由生成について

- **Node（catalyst-bundle-nodejs/ai_matching/index.js）**: **実装済み**。`generate_reasons: true` で上位3件に理由を付与。要 OPENAI_API_KEY。
- **Python（catalyst-function）**: 同様の理由生成を実装済みだが、コンソールの ai_matching は Node のため、**デプロイで使うのは Node 版 ZIP**。

---

## 6. Python 版（catalyst-function）が存在する理由

- コンソールにデプロイされているのは **Node.js** のみ。Python 版は **別スタックで試した／CLI やローカル用に書いた** 経緯でリポジトリに残っている可能性が高い。
- **本番デプロイは Node 版（catalyst-bundle-nodejs）を前提**とする。Python 版は参照用・代替実装として残すか、必要なければ削除してよい。

---

## 7. 次のアクション案

1. コンソールの ai_matching の **スタック**（node18 / node20 等）を確認する。
2. そのスタックに合わせて **catalyst-bundle-nodejs/ai_matching** の catalyst-config.json の `stack` を揃える。
3. **Node 用 ZIP**: `02_テスト/catalyst-bundle-nodejs/ai_matching/` で `npm install` 実行後、`.\pack-for-upload.ps1` で `ai_matching_node.zip` を作成し、コンソールからアップロードする。
4. 環境変数に **OPENAI_API_KEY** を設定すると、検索時に `generate_reasons: true` でマッチング理由が付く（Node 版に実装済み）。
