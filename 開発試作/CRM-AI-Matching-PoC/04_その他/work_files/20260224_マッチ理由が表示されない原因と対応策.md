# ウィジェットで「求人に対して求職者がマッチした理由」が表示されない原因と対応策

**対象**: Etika デモ環境の CRM-AI-Matching-PoC ウィジェット  
**事象**: Zoho Catalyst に OpenAI API キーをセットしたが、ウィジェットにマッチ理由メッセージが出てこない。

---

## 原因の整理

### 1. バックエンドの分岐ロジック（主因）

**場所**: `02_テスト/ai_matching/index.js` の `/search` ハンドラ

- ウィジェットは **`generate_summary: true`** のみ送っている（総合評価1本化のため）。
- コードは **`generate_summary` が true のときは総合評価（summary）だけ生成**し、**`generate_reasons` が true のときだけ** 各マッチに `reason` を付与していた。
- そのため **「総合評価を頼むと、各マッチの理由（reason）は一切生成されない」** 状態だった。

```javascript
// 修正前
if (generate_summary && matches.length > 0) {
    summary = await generateOverallSummary(...);
} else if (generate_reasons && matches.length > 0) {
    await addReasonsToMatches(...);
}
```

### 2. ウィジェットとAPIのプロパティ名の不一致

**場所**: `02_テスト/crm-widget/app/js/widget.js` の詳細モーダル

- バックエンドは各マッチに **`reason`** を付与している。
- ウィジェットは **`ai_reason`** のみ参照しており、**`reason` を見ていなかった**。
- 仮にバックエンドで理由を返していても、フロントでは表示されない実装だった。

### 3. Catalyst 側の環境変数（要確認）

**場所**: Zoho Catalyst コンソール > 該当関数 > 設定（Environment Variables / 環境変数）

- バックエンドは **`process.env.OPENAI_API_KEY`** を参照する。
- Catalyst に「OpenAI / ChatGPT の API キー」を入れる際、**変数名が `OPENAI_API_KEY` と完全一致しているか** 要確認。
- 未設定・別名（例: `OPENAI_KEY`）だと、`generateOverallSummary` も `generateMatchReason` もスキップされ、summary も reason も null のまま返る。

---

## 実施した対応

### 対応1: バックエンドで「総合評価時も per-match 理由を生成」

- **ファイル**: `02_テスト/ai_matching/index.js`
- **変更**: `generate_summary: true` のときも **各マッチに `reason` を付与**するようにした（`generate_reasons` と `generate_summary` のどちらかが true なら `addReasonsToMatches` を実行）。

```javascript
// 修正後
const wantReasons = generate_reasons || generate_summary;
if (generate_summary && matches.length > 0) {
    summary = await generateOverallSummary(...);
}
if (wantReasons && matches.length > 0) {
    await addReasonsToMatches(matches, record, record_type, 3);
}
```

### 対応2: ウィジェットで `reason` を参照する

- **ファイル**: `02_テスト/crm-widget/app/js/widget.js`
- **変更**: 詳細モーダルの「AI 分析コメント」で、**`m.reason` を最優先**で参照し、なければ `m.ai_reason`、さらになければ `globalSummary` を使うようにした。

```javascript
var aiReason = (m.reason && m.reason.trim()) ? m.reason.trim()
  : (m.ai_reason && m.ai_reason.trim()) ? m.ai_reason.trim()
  : (globalSummary && globalSummary.trim()) ? globalSummary.trim() : '';
```

---

## 運用側で確認すること（Etika デモ環境）

1. **Catalyst の環境変数**
   - 該当関数の設定で **名前が `OPENAI_API_KEY`** であること。
   - 値が有効な OpenAI API キーであること（先頭が `sk-` など）。

2. **デプロイの反映**
   - **Catalyst 関数**: 上記修正を反映した `02_テスト/ai_matching` を再デプロイ（ZIP アップロードまたは CLI デプロイ）。
   - **CRM ウィジェット**: 修正した `widget.js` を ZET pack し直し、CRM のウィジェットを再アップロード。

3. **動作確認**
   - 求職者または求人レコードの詳細でウィジェットを開く。
   - マッチ一覧のカードをクリックして詳細モーダルを開き、「✦ AI 分析コメント」に **その求人・求職者に対するマッチ理由** が表示されることを確認。
   - 画面上部の総合評価ブロックに **総合評価テキスト** が表示されることも確認。

---

## まとめ

| 要因 | 内容 | 対応 |
|------|------|------|
| バックエンド分岐 | `generate_summary` 時は reason を生成していなかった | `generate_summary` 時も `addReasonsToMatches` を実行するよう変更 |
| プロパティ名 | ウィジェットが `reason` を参照していなかった | `m.reason` を最優先で参照するよう変更 |
| 環境変数 | Catalyst で `OPENAI_API_KEY` が未設定/別名の可能性 | コンソールで変数名・値を確認し、必要なら修正 |

上記コード修正の反映と、Catalyst の環境変数確認・再デプロイを行えば、マッチ理由メッセージが表示される想定です。
