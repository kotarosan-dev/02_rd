<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Matching Widget</title>
  <script src="https://live.zwidgets.com/js-sdk/1.5/ZohoEmbededAppSDK.min.js"></script>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="app">
    <!-- Toolbar -->
    <div class="toolbar hidden" id="widget-header">
      <div class="toolbar-title">
        <span class="ai-dot" aria-hidden="true"></span>
        AI ãƒãƒƒãƒãƒ³ã‚°
        <span class="toolbar-count" id="match-count"></span>
      </div>
      <button type="button" class="tb-btn" onclick="openWeightModal()" title="é‡ã¿ä»˜ã‘èª¿æ•´">èª¿æ•´</button>
      <button type="button" class="tb-btn" onclick="exportExcel()" title="Excelå‡ºåŠ›">Excel</button>
      <button type="button" class="tb-btn" onclick="openEmailModal()" title="ãƒ¡ãƒ¼ãƒ«é€ä¿¡">ãƒ¡ãƒ¼ãƒ«</button>
      <button type="button" class="tb-btn primary" onclick="retrySearch()" title="å†æ¤œç´¢">å†æ¤œç´¢</button>
    </div>

    <!-- Loading -->
    <div id="loading" class="state-loading">
      <div class="loader-ring"></div>
      <div class="status" id="load-status">ãƒãƒƒãƒãƒ³ã‚°å€™è£œã‚’æ¤œç´¢ä¸­...</div>
    </div>

    <!-- Error -->
    <div id="error" class="state-error hidden">
      <p class="error-message" id="error-message"></p>
      <button type="button" class="tb-btn primary" onclick="retrySearch()">å†è©¦è¡Œ</button>
    </div>

    <!-- Results -->
    <div id="results" class="results hidden">
      <div id="summary-block" class="summary-block hidden">
        <div class="summary-header">
          <span class="summary-title">âœ¦ ãƒãƒƒãƒãƒ³ã‚°ã®ç·åˆè©•ä¾¡</span>
          <button type="button" id="summary-toggle" class="summary-toggle" aria-label="é–‹é–‰">é–‰ã˜ã‚‹</button>
        </div>
        <div id="summary-content" class="summary-content">
          <p id="summary-body" class="summary-body"></p>
        </div>
      </div>
      <div id="match-list" class="card-list"></div>
    </div>

    <!-- Empty -->
    <div id="empty" class="state-empty hidden">
      ãƒãƒƒãƒãƒ³ã‚°å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
      <button type="button" class="tb-btn primary" onclick="retrySearch()" style="margin-top:10px">å†æ¤œç´¢</button>
    </div>
  </div>

  <!-- Detail Modalï¼ˆã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤ºï¼‰ -->
  <div class="modal-overlay" id="detail-modal">
    <div class="modal">
      <div class="modal-head">
        <h3 id="dm-title">è©³ç´°</h3>
        <button type="button" class="modal-close" onclick="closeModal('detail-modal')" aria-label="é–‰ã˜ã‚‹">&times;</button>
      </div>
      <div class="modal-body" id="dm-body"></div>
      <div class="modal-actions">
        <button type="button" class="tb-btn" onclick="closeModal('detail-modal')">é–‰ã˜ã‚‹</button>
        <button type="button" class="tb-btn primary" id="dm-open-record">CRMã§é–‹ã</button>
      </div>
    </div>
  </div>

  <!-- Weight Modal -->
  <div class="modal-overlay" id="weight-modal">
    <div class="modal">
      <div class="modal-head">
        <h3>ğŸšï¸ é‡ã¿ä»˜ã‘èª¿æ•´</h3>
        <button type="button" class="modal-close" onclick="closeModal('weight-modal')" aria-label="é–‰ã˜ã‚‹">&times;</button>
      </div>
      <div class="modal-body">
        <p class="weight-desc">å„è¦ç´ ã®é‡è¦åº¦ã‚’èª¿æ•´ã™ã‚‹ã¨ã€ãƒãƒƒãƒã‚¹ã‚³ã‚¢ãŒå†è¨ˆç®—ã•ã‚Œä¸¦ã³é †ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚</p>
        <div class="weight-sliders" id="weight-sliders"></div>
        <div class="weight-preview" id="weight-preview"></div>
      </div>
      <div class="modal-actions">
        <button type="button" class="tb-btn" onclick="resetWeights()">ãƒªã‚»ãƒƒãƒˆ</button>
        <button type="button" class="tb-btn primary" onclick="applyWeights()">é©ç”¨ã—ã¦å†è¨ˆç®—</button>
      </div>
    </div>
  </div>

  <!-- Email Modal -->
  <div class="modal-overlay" id="email-modal">
    <div class="modal">
      <div class="modal-head">
        <h3>âœ‰ï¸ ãƒãƒƒãƒãƒ³ã‚°çµæœã‚’é€ä¿¡</h3>
        <button type="button" class="modal-close" onclick="closeModal('email-modal')" aria-label="é–‰ã˜ã‚‹">&times;</button>
      </div>
      <div class="modal-body">
        <div class="email-form">
          <div class="email-field">
            <label>å®›å…ˆ</label>
            <input type="email" id="email-to" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
          </div>
          <div class="email-field">
            <label>ä»¶å</label>
            <input type="text" id="email-subject" value="ã€AIåˆ†æã€‘ãƒãƒƒãƒãƒ³ã‚°çµæœãƒ¬ãƒãƒ¼ãƒˆ">
          </div>
          <div class="email-field">
            <label>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="email-msg" rows="3" placeholder="è¿½åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å…¥åŠ›..."></textarea>
          </div>
          <div class="email-field">
            <label>é€ä¿¡å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
            <div class="email-preview" id="email-preview"></div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="tb-btn" onclick="closeModal('email-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" class="tb-btn primary" onclick="sendEmail()">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <!-- PageLoad ã‚’å…ˆã«ä¿å­˜ã€‚widget.js èª­ã¿è¾¼ã¿å‰ã«ç™ºç«ã—ã¦ã‚‚å¾Œã‹ã‚‰å‡¦ç†ã™ã‚‹ -->
  <script>
    window._pendingPageLoad = null;
    ZOHO.embeddedApp.on("PageLoad", function(data) {
      window.currentContext = data;
      if (typeof handlePageLoad === "function") {
        handlePageLoad(data);
      } else {
        window._pendingPageLoad = data;
      }
    });
    ZOHO.embeddedApp.init().then(function() { }).catch(function(err) { console.error(err); });
  </script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="js/widget.js"></script>
</body>
</html>
